---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import TableOfContents from '../components/TableOfContents.vue';
import Twikoo from '../components/Twikoo.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: MarkdownHeading[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;
---
<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
		<style>
			html, body {
				width: 100%;
				box-sizing: border-box;
			}
			*, *::before, *::after {
				box-sizing: border-box;
			}
			main {
				width: 100%;
				max-width: 1400px;
				margin: 50px auto 0 auto;
				padding: 0 2rem;
				box-sizing: border-box;
			}
			/* 覆盖 global.css 中的固定宽度 */
			body main {
				width: 100% !important;
				max-width: 1400px !important;
			}
			.article-container {
				display: grid;
				grid-template-columns: 1fr 250px;
				gap: 3rem;
				align-items: start;
				justify-items: center;
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
			}
			
			/* 移动端防止横向溢出 - 使用 clip 避免影响 sticky */
			@media (max-width: 768px) {
				main {
					overflow-x: clip;
					width: 100%;
				}
				.article-container {
					overflow-x: clip;
					max-width: 100%;
				}
			}
			/* 平板及以下 - 隐藏目录 */
			@media (max-width: 1200px) {
				.article-container {
					grid-template-columns: 1fr;
				}
				aside {
					display: none;
				}
				main {
					padding: 0 1.5rem;
				}
			}

			/* 平板适配 */
			@media (max-width: 1024px) {
				main {
					margin-top: 40px;
					padding: 0 1.5rem;
				}
				article {
					max-width: 100%;
				}
				.hero-image {
					max-width: 100%;
				}
				.article-content {
					max-width: 100%;
					padding: 1em 0.5em;
				}
				.title h1 {
					font-size: 1.75rem;
				}
			}

			/* 移动端适配 */
			@media (max-width: 768px) {
				main {
					padding: 0 0.5rem;
					margin-top: 30px;
					width: 100%;
				}
				article {
					width: 100%;
					max-width: 100%;
					padding: 0;
					overflow-x: hidden;
				}
				.article-content {
					padding: 0.5em 0.5rem;
					width: 100%;
					max-width: 100%;
					overflow-x: hidden;
				}
				.title {
					padding: 0.75em 0;
					margin-bottom: 1em;
				}
				.title h1 {
					font-size: 1.5rem;
					line-height: 1.4;
					margin: 0 0 0.625em 0;
				}
				.article-meta {
					font-size: 0.8rem;
					gap: 0.5rem;
					margin-bottom: 0.875em;
				}
				.meta-item svg {
					width: 14px;
					height: 14px;
				}
				/* 文章内容样式优化 */
				.prose {
					font-size: 0.95rem;
				}
				.prose h1 {
					font-size: 1.5rem;
				}
				.prose h2 {
					font-size: 1.35rem;
					margin-top: 2rem;
					margin-bottom: 1rem;
				}
				.prose h3 {
					font-size: 1.2rem;
				}
				.prose h4 {
					font-size: 1.1rem;
				}
				.prose p {
					margin-top: 1rem;
					margin-bottom: 1rem;
				}
				.prose pre {
					font-size: 0.85rem;
					margin: 1rem -0.25rem;
					border-radius: 6px;
				}
				.prose code {
					font-size: 0.85rem;
				}
				.prose img {
					margin: 1.5rem auto;
					border-radius: 8px;
				}
				.prose ul, .prose ol {
					padding-left: 1.5rem;
				}
				.prose li {
					margin-top: 0.5rem;
					margin-bottom: 0.5rem;
				}
				.prose blockquote {
					margin: 1.5rem 0;
					padding-left: 1rem;
					border-left-width: 3px;
					font-size: 0.9rem;
				}
				.prose table {
					font-size: 0.85rem;
					display: block;
					overflow-x: auto;
					-webkit-overflow-scrolling: touch;
				}
				.prose ul, .prose ol {
					font-size: 0.95rem;
				}
				.prose p, .prose li {
					word-break: break-word;
					overflow-wrap: break-word;
				}
			}

			/* 小屏手机适配 */
			@media (max-width: 480px) {
				main {
					padding: 0 0.5rem;
					margin-top: 20px;
				}
				.article-content {
					padding: 0.5em 0.25rem;
				}
				.title {
					padding: 0.5em 0;
					margin-bottom: 0.875em;
				}
				.title h1 {
					font-size: 1.25rem;
					line-height: 1.35;
					margin-bottom: 0.5em;
				}
				.article-meta {
					font-size: 0.75rem;
					gap: 0.4rem;
					flex-direction: column;
					align-items: flex-start;
				}
				.meta-separator {
					display: none;
				}
				.meta-item svg {
					width: 12px;
					height: 12px;
				}
				/* 文章内容进一步优化 */
				.prose {
					font-size: 0.9rem;
				}
				.prose h1 {
					font-size: 1.35rem;
				}
				.prose h2 {
					font-size: 1.2rem;
					margin-top: 1.75rem;
				}
				.prose h3 {
					font-size: 1.1rem;
				}
				.prose h4 {
					font-size: 1rem;
				}
				.prose pre {
					font-size: 0.8rem;
					margin: 1rem -0.75rem;
					border-radius: 4px;
					overflow-x: auto;
				}
				.prose code {
					font-size: 0.8rem;
				}
				.prose ul, .prose ol {
					padding-left: 1.25rem;
				}
				.prose blockquote {
					margin: 1rem 0;
					padding-left: 0.75rem;
					font-size: 0.9rem;
				}
				.prose table {
					font-size: 0.8rem;
					display: block;
					overflow-x: auto;
				}
			}

			/* 极小屏幕 */
			@media (max-width: 360px) {
				main {
					padding: 0 0.5rem;
				}
				.title h1 {
					font-size: 1.15rem;
				}
				.prose {
					font-size: 0.85rem;
				}
				.prose h2 {
					font-size: 1.1rem;
				}
			}
			article {
				width: 100%;
				max-width: 100%;
				box-sizing: border-box;
			}
			/* PC端样式 */
			@media (min-width: 1201px) {
				article {
					max-width: 820px;
				}
				.hero-image {
					max-width: 720px;
				}
				.article-content {
					max-width: 720px;
				}
			}
			.hero-image {
				width: 100%;
				margin: 0 auto;
				box-sizing: border-box;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
				width: 100%;
				max-width: 100%;
				height: auto;
			}
			.article-content {
				width: 100%;
				margin: 0 auto;
				padding: 1em;
				box-sizing: border-box;
			}
			.title {
				margin-bottom: 1.5em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.75em 0;
				font-size: 2rem;
				font-weight: 600;
				line-height: 1.3;
				word-wrap: break-word;
				overflow-wrap: break-word;
			}
			.article-meta {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 0.75rem;
				flex-wrap: wrap;
				font-size: 0.875rem;
				color: var(--ring);
				margin-bottom: 1em;
			}
			.meta-item {
				display: flex;
				align-items: center;
				gap: 0.25rem;
			}
			.meta-item svg {
				width: 16px;
				height: 16px;
				flex-shrink: 0;
			}
			.meta-separator {
				color: rgb(var(--gray-light));
			}
			.last-updated {
				font-style: italic;
			}
			aside {
				position: sticky;
				top: 80px;
				height: calc(100vh - 100px);
			}
			/* 文章内容全局样式 */
			.prose {
				width: 100% !important;
				max-width: 100% !important;
				word-wrap: break-word;
				overflow-wrap: break-word;
				box-sizing: border-box;
				overflow-x: auto;
			}
			.prose * {
				max-width: 100% !important;
				box-sizing: border-box;
			}
			.prose > * {
				max-width: 100% !important;
			}
			.prose pre {
				overflow-x: auto;
				width: 100%;
				box-sizing: border-box;
			}
			.prose code {
				word-wrap: break-word;
				overflow-wrap: break-word;
			}
			.prose pre code {
				word-break: normal;
				white-space: pre;
			}
			.prose table {
				display: block;
				width: 100%;
				overflow-x: auto;
				box-sizing: border-box;
			}
			.prose img {
				width: 100%;
				height: auto;
				max-width: 100%;
			}
			/* 确保 div 元素也不会溢出 */
			.prose div {
				max-width: 100% !important;
				overflow-x: auto;
			}
			/* 处理内联元素 */
			.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
				word-wrap: break-word;
				overflow-wrap: break-word;
			}
			/* 确保所有文本内容都不会溢出 */
			.prose p, .prose li, .prose td, .prose th {
				word-wrap: break-word;
				overflow-wrap: break-word;
				word-break: break-word;
			}
			/* 强制限制所有子元素 */
			.article-content * {
				max-width: 100%;
			}
			/* 代码块特殊处理 */
			.prose pre {
				max-width: 100% !important;
				overflow-x: auto !important;
			}
			.prose code {
				max-width: 100%;
				overflow-wrap: break-word;
			}
			/* 确保 blockquote 不溢出 */
			.prose blockquote {
				max-width: 100%;
				overflow-x: auto;
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<div class="article-container">
				<article>
					<div class="hero-image">
						{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
					</div>
					<div class="article-content">
						<div class="title">
							<h1>{title}</h1>
							<div class="article-meta">
								<span class="meta-separator">•</span>
								<span class="meta-item">
									<FormattedDate date={pubDate} />
								</span>
								{
									updatedDate && (
										<>
											<span class="meta-separator">•</span>
											<span class="meta-item last-updated">
												Updated: <FormattedDate date={updatedDate} />
											</span>
										</>
									)
								}
								<span class="meta-separator">•</span>
								<span class="meta-item flex!" id="busuanzi_container_page_pv">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
										<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
									</svg>
									<span id="busuanzi_value_page_pv">-</span>
								</span>
							</div>
							<hr />
						</div>
						<div class="prose prose-zinc dark:prose-invert max-w-full">
							<slot />
						</div>
						<div class="w-full h-[50px]"></div>
						<!-- Twikoo 评论组件 -->
						<Twikoo />
					</div>
				</article>
				{headings.length > 0 && (
					<aside>
						<TableOfContents client:load headings={headings} />
					</aside>
				)}
			</div>
		</main>
		<Footer />
	</body>
</html>
