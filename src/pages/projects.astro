---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';

// GitHub 仓库列表 - 只需要填写仓库的 owner/repo 格式
const repos = [
	'xinnan-tech/xiaozhi-esp32-server',
	'huangjunsen0406/py-xiaozhi',
	'huangjunsen0406/UnifyPy',
	'huangjunsen0406/EnvHub',
	'huangjunsen0406/xiaozhi-mcphub',
];

// 从 GitHub API 获取仓库信息
async function fetchRepoData(repo: string) {
	try {
		const response = await fetch(`https://api.github.com/repos/${repo}`, {
			headers: {
				'Accept': 'application/vnd.github.v3+json',
				// 如果有 GitHub Token 可以添加以提高 API 限制
				// 'Authorization': `token ${import.meta.env.GITHUB_TOKEN}`
			},
		});

		if (!response.ok) {
			console.error(`Failed to fetch ${repo}: ${response.status}`);
			return null;
		}

		const data = await response.json();

		return {
			name: data.name,
			description: data.description || '暂无描述',
			url: data.html_url,
			stars: data.stargazers_count || 0,
			tags: data.topics || [], // GitHub topics 作为标签
			language: data.language, // 主要编程语言
		};
	} catch (error) {
		console.error(`Error fetching ${repo}:`, error);
		return null;
	}
}

// 获取所有仓库数据
const projectsData = await Promise.all(repos.map(repo => fetchRepoData(repo)));
const projects = projectsData.filter((p): p is NonNullable<typeof p> => p !== null); // 过滤掉失败的请求
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`开源项目 - ${SITE_TITLE}`} description="我的开源项目展示" />
		<style>
			main {
				width: 800px;
				max-width: 100%;
				margin: 0 auto;
				padding: 3rem 1rem;
			}

			.page-title {
				font-size: 2rem;
				font-weight: 600;
				margin-bottom: 1rem;
				color: rgb(var(--black));
			}

			.page-intro {
				font-size: 1rem;
				color: var(--ring);
				margin-bottom: 3rem;
				line-height: 1.6;
			}

			.projects-list {
				list-style-type: none;
				margin: 0;
				padding: 0;
				display: flex;
				flex-direction: column;
				gap: 2rem;
			}

			.project-item {
				border: 1px solid rgb(var(--gray-light));
				border-radius: 8px;
				padding: 1.5rem;
				transition: all 0.2s ease;
			}

			.project-item:hover {
				border-color: var(--title);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			}

			.project-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 1rem;
				gap: 1rem;
			}

			.project-name {
				font-size: 1.25rem;
				font-weight: 600;
				margin: 0;
				color: rgb(var(--black));
			}

			.project-link {
				text-decoration: none;
				color: var(--title);
				transition: opacity 0.2s ease;
			}

			.project-link:hover {
				opacity: 0.7;
			}

			.project-stars {
				display: flex;
				align-items: center;
				gap: 0.25rem;
				font-size: 0.875rem;
				color: var(--ring);
				flex-shrink: 0;
			}

			.star-icon {
				width: 16px;
				height: 16px;
			}

			.project-description {
				margin: 0 0 1rem 0;
				font-size: 0.9rem;
				color: rgb(var(--black));
				line-height: 1.7;
			}

			.project-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
			}

			.project-tag {
				padding: 0.25rem 0.75rem;
				background: rgb(var(--gray-light));
				border-radius: 4px;
				font-size: 0.8rem;
				color: var(--ring);
			}

			.language-tag {
				background: var(--title);
				color: white;
			}

			.github-link {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				margin-top: 1rem;
				padding: 0.5rem 1rem;
				background: rgb(var(--black));
				color: var(--black);
				text-decoration: none;
				border-radius: 6px;
				font-size: 0.9rem;
				transition: opacity 0.2s ease;
			}

			.github-link:hover {
				opacity: 0.8;
			}

			.github-icon {
				width: 20px;
				height: 20px;
			}

			@media (max-width: 720px) {
				main {
					padding: 2rem 1rem;
				}

				.page-title {
					font-size: 1.5rem;
				}

				.project-item {
					padding: 1rem;
				}

				.project-header {
					flex-direction: column;
					align-items: flex-start;
				}

				.project-name {
					font-size: 1.125rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<h1 class="page-title">开源项目</h1>
			<p class="page-intro">这些是我开发和维护的开源项目，欢迎使用和贡献！</p>

			<ul class="projects-list">
				{projects.map((project) => (
					<li class="project-item">
						<div class="project-header">
							<h3 class="project-name">
								<a href={project.url} target="_blank" rel="noopener noreferrer" class="project-link">
									{project.name}
								</a>
							</h3>
							{project.stars > 0 && (
								<div class="project-stars">
									<svg class="star-icon" viewBox="0 0 16 16" fill="currentColor">
										<path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z" />
									</svg>
									<span>{project.stars}</span>
								</div>
							)}
						</div>
						<p class="project-description">{project.description}</p>
						{(project.tags && project.tags.length > 0) || project.language ? (
							<div class="project-tags">
								{project.language && (
									<span class="project-tag language-tag">{project.language}</span>
								)}
								{project.tags && project.tags.map((tag: string) => (
									<span class="project-tag">{tag}</span>
								))}
							</div>
						) : null}
						<a href={project.url} target="_blank" rel="noopener noreferrer" class="github-link">
							<svg class="github-icon" viewBox="0 0 16 16" fill="currentColor">
								<path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
							</svg>
							View on GitHub
						</a>
					</li>
				))}
			</ul>
		</main>
		<Footer />
	</body>
</html>
